<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Burke Crypto Analytics - Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- FONTS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --lavender: #dcd0ff;
      --blue: #71c5ff;
      --text-main: #f6f3ff;
      --text-muted: #a9b0d6;
      --success: #5dd9a3;
      --danger: #ff5c8a;
    }

    .soft-glow {
      text-shadow:
        0 0 2px var(--blue),
        0 0 6px rgba(113,197,255,0.7);
    }

    .underline-soft {
      position: relative;
    }
    .underline-soft::after {
      content: "";
      display: block;
      width: 45%;
      height: 1px;
      margin-top: 0.3rem;
      background: var(--lavender);
      border-radius: 1px;
      box-shadow: 0 3px 6px rgba(113,197,255,0.6);
    }

    .hidden { display: none; }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      background: #050716;
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      background: rgba(15,18,42,0.9);
      backdrop-filter: blur(8px);
      border-radius: 36px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.45);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .hamburger {
      width: 32px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .hamburger .bar {
      width: 100%;
      height: 4px;
      border-radius: 4px;
      background: linear-gradient(90deg, #bfa8ff, #71c5ff);
      box-shadow:
        0 0 3px var(--blue),
        0 0 7px rgba(113,197,255,0.8);
    }

    .logo-title {
      flex: 1;
      text-align: center;
      font-family: "Playfair Display", serif;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-right: 18px;
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(20px);
      background: rgba(10,12,32,0.65);
      transition: left .35s ease;
      z-index: 999;
      padding: 1.5rem;
    }
    .menu-overlay.active { left: 0; }

    .menu-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      font-size: 2rem;
      line-height: 1;
      color: var(--lavender);
      text-shadow:
        0 0 2px var(--blue),
        0 0 6px rgba(113,197,255,0.7),
        0 0 10px rgba(113,197,255,0.5);
    }

    .menu-title {
      margin-top: 3.5rem;
      text-align: center;
      font-family: "Playfair Display", serif;
      font-size: 1.4rem;
      color: var(--lavender);
    }

    .menu-items {
      margin-top: 3.5rem;
      text-align: center;
    }
    .menu-item {
      display: block;
      font-family: "Playfair Display", serif;
      font-size: 1.6rem;
      margin: 1.3rem 0;
      color: var(--lavender);
      letter-spacing: 0.06em;
      cursor: pointer;
      text-decoration: none;
      text-shadow:
        0 0 2px var(--blue),
        0 0 6px rgba(113,197,255,0.7);
    }
    .menu-item::after {
      content: "";
      display: block;
      width: 55%;
      height: 1px;
      background: var(--lavender);
      border-radius: 1px;
      margin: 0.35rem auto 0;
      box-shadow: 0 3px 6px rgba(113,197,255,0.6);
    }

    .card {
      margin-top: 1rem;
      padding: 1.3rem 1.2rem;
      background: rgba(12,14,35,0.95);
      border-radius: 24px;
      border: 1px solid rgba(140,155,255,0.3);
    }

    .page-title {
      font-family: "Playfair Display", serif;
      font-size: 1.4rem;
      color: var(--lavender);
      margin: 0;
      letter-spacing: 0.03em;
      text-shadow:
        0 0 2px var(--blue),
        0 0 6px rgba(113,197,255,0.7);
    }

    .view-description {
      margin: .6rem 0 1rem;
      color: var(--text-muted);
      font-size: .8rem;
    }

    .primary-pill {
      background: linear-gradient(135deg, #bfa8ff, #71c5ff);
      color: #06061a;
      padding: 0.55rem 1.2rem;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      margin-right: .6rem;
      box-shadow:
        0 0 3px var(--blue),
        0 0 7px rgba(113,197,255,0.8);
      transition: opacity 0.15s ease, transform 0.1s ease;
    }
    .primary-pill:active {
      transform: scale(0.98);
    }

    .ghost-pill {
      background: transparent;
      border: 1px solid rgba(165, 177, 255, 0.5);
      color: var(--lavender);
      padding: 0.55rem 1.2rem;
      border-radius: 999px;
      cursor: pointer;
      transition: opacity 0.15s ease, transform 0.1s ease;
    }
    .ghost-pill:active {
      transform: scale(0.98);
    }

    .pill-busy {
      opacity: 0.6;
      cursor: wait;
    }

    #lastUpdated {
      margin-top: 0.4rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* ---------- OVERLAY MODALS ---------- */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(18px);
      background: rgba(5, 7, 22, 0.7);
      z-index: 1000;
    }
    .overlay.hidden {
      display: none;
    }

    .token-form {
      width: 100%;
      max-width: 420px;
      margin: 0;
      padding: 1rem;
      background: rgba(16,18,45,0.98);
      border-radius: 18px;
      border: 1px solid rgba(140,155,255,0.7);
      position: relative;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.8),
        0 0 8px rgba(113,197,255,0.4);
    }

    .token-form-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.4rem;
    }

    .token-form-title {
      font-family: "Playfair Display", serif;
      font-size: 1rem;
      color: var(--lavender);
    }

    .token-form-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.4rem;
      line-height: 1;
      color: var(--lavender);
      text-shadow:
        0 0 2px var(--blue),
        0 0 6px rgba(113,197,255,0.7);
    }

    .token-form-subtext {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.7rem;
    }

    .form-row { margin-bottom: 0.6rem; }
    .form-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.2rem;
    }

    .token-input,
    .token-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(140,155,255,0.5);
      background: rgba(10,12,35,0.95);
      color: var(--text-main);
      padding: 0.5rem 0.8rem;
      font-size: 0.8rem;
      font-family: inherit;
    }

    .token-input::placeholder {
      color: rgba(169,176,214,0.7);
    }

    /* Tokens list container */
    .tokens-list {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    /* Token cards */
    .token-card {
      position: relative;
      border-radius: 20px;
      padding: 0.85rem 1rem;
      background:
        radial-gradient(circle at top left, rgba(113,197,255,0.2), rgba(10,12,35,0.98));
      border: 1px solid rgba(140,155,255,0.7);
      box-shadow:
        0 18px 40px rgba(0,0,0,0.75),
        0 0 8px rgba(113,197,255,0.4);
    }

    .token-card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.2rem;
    }

    .token-card-header {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .token-card-amount {
      font-size: 0.74rem;
      color: var(--text-muted);
      margin-bottom: 0.55rem;
    }

    .token-row-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      margin: 0.1rem 0;
    }

    .token-row-label {
      color: var(--text-muted);
    }

    .token-row-value {
      font-weight: 500;
    }

    .token-pnl-positive { color: var(--success); }
    .token-pnl-negative { color: var(--danger); }

    .token-pct {
      margin-left: 0.4rem;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(10,12,35,0.95);
      border: 1px solid currentColor;
    }

    #emptyState {
      margin-top: 0.8rem;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* three-dot menu button */
    .token-menu-btn {
      background: transparent;
      border: none;
      color: var(--lavender);
      font-size: 1.2rem;
      padding: 0;
      cursor: pointer;
    }

    .token-menu {
      position: absolute;
      top: 0.6rem;
      right: 0.8rem;
      background: rgba(8,10,30,0.98);
      border-radius: 12px;
      border: 1px solid rgba(140,155,255,0.7);
      box-shadow: 0 14px 30px rgba(0,0,0,0.8);
      padding: 0.25rem 0;
      min-width: 120px;
      z-index: 10;
    }

    .token-menu-item {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 0.78rem;
      text-align: left;
      padding: 0.35rem 0.8rem;
      cursor: pointer;
    }

    .token-menu-item:not(:last-child) {
      border-bottom: 1px solid rgba(40,50,100,0.8);
    }

    .token-menu-delete {
      color: var(--danger);
    }
  </style>
</head>

<body>

  <!-- MENU OVERLAY -->
  <div class="menu-overlay" id="menuOverlay">
    <button class="menu-close" id="menuClose">×</button>

    <div class="menu-title soft-glow">Menu</div>

    <div class="menu-items">
      <a class="menu-item" href="index.html">Overview</a>
      <a class="menu-item" href="tracking.html">Tracker</a>
      <a class="menu-item" href="charts.html">Charts</a>
    </div>
  </div>

  <div class="app-shell">
    <header class="top-bar">
      <div class="hamburger" id="hamburger">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
      </div>
      <div class="logo-title">Burke Crypto Analytics</div>
    </header>

    <main class="card">
      <h2 class="page-title underline-soft">Tracking</h2>
      <p class="view-description">
        Add tokens, lock entries, and track your coins effortlessly.
      </p>

      <button id="addTokenBtn" class="primary-pill">Add token</button>
      <button id="refreshPricesBtn" class="ghost-pill">Refresh prices</button>
      <p id="lastUpdated"></p>

      <!-- TOKEN FORM OVERLAY (NEW / EDIT) -->
      <div id="tokenFormOverlay" class="overlay hidden">
        <div id="tokenForm" class="token-form">
          <div class="token-form-header">
            <div>
              <div class="token-form-title" id="tokenFormTitle">New token entry</div>
              <div class="token-form-subtext" id="tokenFormSubtitle">
                Choose a coin, log your entry, we’ll track the rest.
              </div>
            </div>
            <button class="token-form-close" id="tokenFormClose">×</button>
          </div>

          <form id="tokenFormElement">
            <div class="form-row">
              <label class="form-label" for="quickCoinSelect">Quick coin select</label>
              <select id="quickCoinSelect" class="token-select">
                <option value="">Choose a popular coin…</option>
                <option value="bitcoin|BTC|Bitcoin">Bitcoin (BTC)</option>
                <option value="ethereum|ETH|Ethereum">Ethereum (ETH)</option>
                <option value="solana|SOL|Solana">Solana (SOL)</option>
                <option value="ripple|XRP|XRP">XRP (XRP)</option>
                <option value="dogecoin|DOGE|Dogecoin">Dogecoin (DOGE)</option>
                <option value="cardano|ADA|Cardano">Cardano (ADA)</option>
              </select>
            </div>

            <div class="form-row">
              <label class="form-label" for="coinName">Name of coin</label>
              <input id="coinName" class="token-input" type="text" placeholder="e.g. Bitcoin" required />
            </div>

            <div class="form-row">
              <label class="form-label" for="coinSymbol">Symbol / ticker</label>
              <input id="coinSymbol" class="token-input" type="text" placeholder="e.g. BTC" required />
            </div>

            <div class="form-row">
              <label class="form-label" id="amountLabel" for="coinAmount">Amount of coin bought</label>
              <input id="coinAmount" class="token-input" type="number" min="0" step="0.00000001" placeholder="e.g. 0.00457278" required />
            </div>

            <div class="form-row">
              <label class="form-label" for="totalSpent">Total spent (USD)</label>
              <input id="totalSpent" class="token-input" type="number" min="0" step="0.01" placeholder="e.g. 411" required />
            </div>

            <div class="form-row" style="margin-top:0.8rem;">
              <button type="submit" class="primary-pill">Save token</button>
            </div>
          </form>
        </div>
      </div>

      <!-- ADD MORE OVERLAY -->
      <div id="addMoreOverlay" class="overlay hidden">
        <div id="addMoreForm" class="token-form">
          <div class="token-form-header">
            <div>
              <div class="token-form-title" id="addMoreTitle">Add more</div>
              <div class="token-form-subtext" id="addMoreSubtitle">
                Add more to this position.
              </div>
            </div>
            <button class="token-form-close" id="addMoreClose">×</button>
          </div>

          <form id="addMoreFormElement">
            <div class="form-row">
              <label class="form-label" id="addMoreAmountLabel" for="addMoreAmount">Additional amount bought</label>
              <input id="addMoreAmount" class="token-input" type="number" min="0" step="0.00000001" placeholder="e.g. 0.001" required />
            </div>

            <div class="form-row">
              <label class="form-label" for="addMoreUsd">Additional spent (USD)</label>
              <input id="addMoreUsd" class="token-input" type="number" min="0" step="0.01" placeholder="e.g. 75" required />
            </div>

            <div class="form-row" style="margin-top:0.8rem;">
              <button type="submit" class="primary-pill">Save</button>
            </div>
          </form>
        </div>
      </div>

      <!-- TOKENS LIST -->
      <div class="tokens-list" id="tokensList"></div>
      <p id="emptyState">No tokens yet.</p>
    </main>
  </div>

  <script>
    /* MENU BEHAVIOR */
    const hamburger   = document.getElementById("hamburger");
    const menuOverlay = document.getElementById("menuOverlay");
    const menuClose   = document.getElementById("menuClose");

    hamburger.addEventListener("click", () => {
      menuOverlay.classList.add("active");
    });
    menuClose.addEventListener("click", () => {
      menuOverlay.classList.remove("active");
    });

    /* TOKEN FORM + TRACKER LOGIC */
    const addTokenBtn        = document.getElementById("addTokenBtn");
    const refreshPricesBtn   = document.getElementById("refreshPricesBtn");
    const lastUpdatedEl      = document.getElementById("lastUpdated");

    const tokenFormOverlay   = document.getElementById("tokenFormOverlay");
    const tokenForm          = document.getElementById("tokenForm");
    const tokenFormClose     = document.getElementById("tokenFormClose");
    const tokenFormElement   = document.getElementById("tokenFormElement");
    const tokenFormTitle     = document.getElementById("tokenFormTitle");
    const tokenFormSubtitle  = document.getElementById("tokenFormSubtitle");

    const addMoreOverlay       = document.getElementById("addMoreOverlay");
    const addMoreForm          = document.getElementById("addMoreForm");
    const addMoreClose         = document.getElementById("addMoreClose");
    const addMoreFormElement   = document.getElementById("addMoreFormElement");
    const addMoreAmountInput   = document.getElementById("addMoreAmount");
    const addMoreUsdInput      = document.getElementById("addMoreUsd");
    const addMoreTitle         = document.getElementById("addMoreTitle");
    const addMoreSubtitle      = document.getElementById("addMoreSubtitle");
    const addMoreAmountLabel   = document.getElementById("addMoreAmountLabel");

    const quickCoinSelect    = document.getElementById("quickCoinSelect");
    const coinNameInput      = document.getElementById("coinName");
    const coinSymbolInput    = document.getElementById("coinSymbol");
    const amountLabel        = document.getElementById("amountLabel");
    const coinAmountInput    = document.getElementById("coinAmount");
    const totalSpentInput    = document.getElementById("totalSpent");

    const tokensList         = document.getElementById("tokensList");
    const emptyState         = document.getElementById("emptyState");

    const STORAGE_KEY = "bca_tokens_v1";
    let tokens = [];

    const COINGECKO_MAP = {
      BTC: "bitcoin",
      ETH: "ethereum",
      SOL: "solana",
      XRP: "ripple",
      DOGE: "dogecoin",
      ADA: "cardano"
    };

    let formMode     = "new";   // "new" | "edit"
    let editingIndex = null;
    let addMoreIndex = null;

    function loadTokens() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        tokens = raw ? JSON.parse(raw) : [];
      } catch (e) {
        tokens = [];
      }
    }

    function saveTokens() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tokens));
      } catch (e) {
        console.error("Failed to save tokens", e);
      }
    }

    // Helpers to open/close overlays
    function openTokenForm() {
      tokenFormOverlay.classList.remove("hidden");
      addTokenBtn.style.display = "none";
    }
    function closeTokenForm() {
      tokenFormOverlay.classList.add("hidden");
      addTokenBtn.style.display = "inline-block";
      tokenFormElement.reset();
      quickCoinSelect.value = "";
      amountLabel.textContent = "Amount of coin bought";
      formMode = "new";
      editingIndex = null;
    }

    function openAddMoreForm() {
      addMoreOverlay.classList.remove("hidden");
      addTokenBtn.style.display = "none";
    }
    function closeAddMoreForm() {
      addMoreOverlay.classList.add("hidden");
      addMoreFormElement.reset();
      addMoreIndex = null;
      addTokenBtn.style.display = "inline-block";
    }

    addTokenBtn.addEventListener("click", () => {
      formMode = "new";
      editingIndex = null;
      tokenFormTitle.textContent = "New token entry";
      tokenFormSubtitle.textContent = "Choose a coin, log your entry, we’ll track the rest.";
      openTokenForm();
    });

    tokenFormClose.addEventListener("click", closeTokenForm);
    addMoreClose.addEventListener("click", closeAddMoreForm);

    // click on dark overlay background closes the modals
    tokenFormOverlay.addEventListener("click", (e) => {
      if (e.target === tokenFormOverlay) closeTokenForm();
    });
    addMoreOverlay.addEventListener("click", (e) => {
      if (e.target === addMoreOverlay) closeAddMoreForm();
    });

    function updateAmountLabel() {
      const sym = coinSymbolInput.value.trim().toUpperCase();
      if (sym) {
        amountLabel.textContent = `${sym} bought`;
      } else {
        amountLabel.textContent = "Amount of coin bought";
      }
    }

    quickCoinSelect.addEventListener("change", (e) => {
      const value = e.target.value;
      if (!value) return;
      const [id, sym, name] = value.split("|");
      coinNameInput.value = name;
      coinSymbolInput.value = sym;
      updateAmountLabel();
    });

    coinSymbolInput.addEventListener("input", updateAmountLabel);

    async function fetchCurrentPrice(symbol) {
      const upper = symbol.toUpperCase();
      const id = COINGECKO_MAP[upper];
      if (!id) return null;

      try {
        const res = await fetch(
          "https://api.coingecko.com/api/v3/simple/price?ids=" +
          encodeURIComponent(id) +
          "&vs_currencies=usd"
        );
        if (!res.ok) return null;
        const data = await res.json();
        if (!data[id] || typeof data[id].usd !== "number") return null;
        return data[id].usd;
      } catch (err) {
        console.error("Price fetch failed", err);
        return null;
      }
    }

    function formatTimestamp() {
      const d = new Date();
      const hours = d.getHours();
      const minutes = d.getMinutes().toString().padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      const hr12 = hours % 12 || 12;
      return `${hr12}:${minutes} ${ampm}`;
    }

    function renderTokens() {
      tokensList.innerHTML = "";

      if (!tokens.length) {
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      tokens.forEach((t, index) => {
        const isProfit = t.pnl >= 0;
        const pnlLabel = isProfit ? "Profit" : "Loss";
        const pnlClass = isProfit ? "token-pnl-positive" : "token-pnl-negative";
        const sign = isProfit ? "+" : "";
        const pct = t.cost !== 0 ? (t.pnl / t.cost) * 100 : 0;

        const card = document.createElement("div");
        card.className = "token-card";
        card.dataset.index = index;

        card.innerHTML = `
          <div class="token-card-header-row">
            <div class="token-card-header">${t.name} (${t.symbol})</div>
            <button class="token-menu-btn" type="button" aria-label="Token menu">⋮</button>
            <div class="token-menu hidden">
              <button class="token-menu-item" data-action="edit" type="button">Edit</button>
              <button class="token-menu-item" data-action="add" type="button">Add</button>
              <button class="token-menu-item token-menu-delete" data-action="delete" type="button">Delete</button>
            </div>
          </div>

          <div class="token-card-amount">Amount: ${t.amount}</div>

          <div class="token-row-line">
            <div class="token-row-label">Cost</div>
            <div class="token-row-value">$${t.cost.toFixed(2)}</div>
          </div>

          <div class="token-row-line">
            <div class="token-row-label">Value</div>
            <div class="token-row-value ${pnlClass}">
              $${t.value.toFixed(2)}
              <span class="token-pct ${pnlClass}">${sign}${pct.toFixed(2)}%</span>
            </div>
          </div>

          <div class="token-row-line">
            <div class="token-row-label">${pnlLabel}</div>
            <div class="token-row-value ${pnlClass}">$${t.pnl.toFixed(2)}</div>
          </div>
        `;

        tokensList.appendChild(card);
      });
    }

    // Handle clicks on token cards (menu + actions)
    tokensList.addEventListener("click", (e) => {
      const card = e.target.closest(".token-card");
      if (!card) return;
      const index = parseInt(card.dataset.index, 10);
      if (Number.isNaN(index)) return;

      const menuBtn = e.target.closest(".token-menu-btn");
      if (menuBtn) {
        const menu = card.querySelector(".token-menu");
        if (menu) menu.classList.toggle("hidden");
        return;
      }

      const menuItem = e.target.closest(".token-menu-item");
      if (!menuItem) return;

      const action = menuItem.dataset.action;
      const menu = card.querySelector(".token-menu");
      if (menu) menu.classList.add("hidden");

      if (action === "delete") {
        tokens.splice(index, 1);
        saveTokens();
        renderTokens();
      } else if (action === "edit") {
        const t = tokens[index];
        formMode = "edit";
        editingIndex = index;

        tokenFormTitle.textContent = `Edit ${t.symbol}`;
        tokenFormSubtitle.textContent = "Adjust your amount and total spent.";

        coinNameInput.value = t.name;
        coinSymbolInput.value = t.symbol;
        coinAmountInput.value = t.amount;
        totalSpentInput.value = t.totalSpent;
        updateAmountLabel();

        openTokenForm();
      } else if (action === "add") {
        const t = tokens[index];
        addMoreIndex = index;

        addMoreTitle.textContent = `Add more ${t.symbol}`;
        addMoreSubtitle.textContent = `Add more ${t.symbol} and USD spent to this position.`;
        addMoreAmountLabel.textContent = `${t.symbol} bought`;

        openAddMoreForm();
      }
    });

    tokenFormElement.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name       = coinNameInput.value.trim();
      const symbol     = coinSymbolInput.value.trim().toUpperCase();
      const amount     = parseFloat(coinAmountInput.value);
      const totalSpent = parseFloat(totalSpentInput.value);

      if (!name || !symbol || isNaN(amount) || isNaN(totalSpent) || amount <= 0) {
        alert("Please fill out all fields with valid values.");
        return;
      }

      const buyPrice = totalSpent / amount;

      let lastPrice = await fetchCurrentPrice(symbol);
      if (formMode === "edit" && editingIndex !== null && (lastPrice === null)) {
        const existing = tokens[editingIndex];
        lastPrice = existing.lastPrice || buyPrice;
      }
      if (lastPrice === null) lastPrice = buyPrice;

      const cost  = totalSpent;
      const value = lastPrice * amount;
      const pnl   = value - cost;

      if (formMode === "edit" && editingIndex !== null) {
        const existing = tokens[editingIndex];
        tokens[editingIndex] = {
          ...existing,
          name,
          symbol,
          amount,
          totalSpent,
          buyPrice,
          lastPrice,
          cost,
          value,
          pnl
        };
      } else {
        tokens.push({
          name,
          symbol,
          amount,
          totalSpent,
          buyPrice,
          lastPrice,
          cost,
          value,
          pnl
        });
      }

      saveTokens();
      renderTokens();
      closeTokenForm();
    });

    addMoreFormElement.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (addMoreIndex === null) return;

      const extraAmount = parseFloat(addMoreAmountInput.value);
      const extraUsd    = parseFloat(addMoreUsdInput.value);

      if (isNaN(extraAmount) || extraAmount <= 0 || isNaN(extraUsd) || extraUsd < 0) {
        alert("Please enter a valid extra amount and USD spent.");
        return;
      }

      const t = tokens[addMoreIndex];

      t.amount      = (t.amount || 0) + extraAmount;
      t.totalSpent  = (t.totalSpent || 0) + extraUsd;
      t.buyPrice    = t.totalSpent / t.amount;

      let lastPrice = await fetchCurrentPrice(t.symbol);
      if (lastPrice === null) lastPrice = t.lastPrice || t.buyPrice;

      t.lastPrice = lastPrice;
      t.cost      = t.totalSpent;
      t.value     = t.lastPrice * t.amount;
      t.pnl       = t.value - t.cost;

      tokens[addMoreIndex] = t;

      saveTokens();
      renderTokens();
      closeAddMoreForm();
    });

    // Refresh prices button with feedback
    refreshPricesBtn.addEventListener("click", async () => {
      if (!tokens.length) return;

      refreshPricesBtn.classList.add("pill-busy");
      const originalText = refreshPricesBtn.textContent;
      refreshPricesBtn.textContent = "Refreshing…";

      let updatedCount = 0;

      try {
        for (let i = 0; i < tokens.length; i++) {
          const t = tokens[i];
          const p = await fetchCurrentPrice(t.symbol);
          if (p !== null) {
            t.lastPrice = p;
            t.value     = p * t.amount;
            t.pnl       = t.value - t.cost;
            updatedCount++;
          }
        }

        if (updatedCount > 0) {
          saveTokens();
          renderTokens();
          lastUpdatedEl.textContent = `Last updated: ${formatTimestamp()} (${updatedCount} token${updatedCount > 1 ? "s" : ""})`;
        } else {
          lastUpdatedEl.textContent = "No prices refreshed (only BTC, ETH, SOL, XRP, DOGE, ADA are supported right now).";
        }
      } catch (err) {
        console.error("Refresh failed", err);
        lastUpdatedEl.textContent = "Could not refresh prices (network error).";
      } finally {
        refreshPricesBtn.classList.remove("pill-busy");
        refreshPricesBtn.textContent = originalText;
      }
    });

    // Load saved tokens on startup
    loadTokens();
    renderTokens();
  </script>

</body>
</html>
